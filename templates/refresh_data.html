<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refreshing Data - Diablo 4 Build Search Tool</title>
    <style>
        :root {
            --primary-color: #8b0000;
            --secondary-color: #333;
            --text-color: #eee;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --accent-color: #ff4040;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }
        
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 4px solid #470000;
        }
        
        h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        /* Navigation styles */
        .main-nav {
            background-color: #1a1a1a;
            border-bottom: 1px solid #333;
            margin-bottom: 30px;
        }
        
        .nav-list {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .nav-item {
            display: block;
            padding: 15px 20px;
            color: var(--text-color);
            text-decoration: none;
            font-weight: bold;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .nav-item:hover {
            background-color: #252525;
            color: var(--accent-color);
        }
        
        .nav-item.active {
            border-bottom-color: var(--primary-color);
            color: var(--accent-color);
        }
        
        .refresh-container {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .refresh-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .refresh-title {
            font-size: 1.8em;
            color: var(--accent-color);
            margin: 0;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
        }

        .refresh-button {
            border: none;
            border-radius: 4px;
            padding: 10px 18px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            background-color: #2a2a2a;
            color: var(--text-color);
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        .refresh-button.primary {
            background-color: var(--primary-color);
            color: white;
        }

        .refresh-button:hover:not(:disabled) {
            background-color: var(--accent-color);
            color: white;
            transform: translateY(-1px);
        }

        .refresh-button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
        }

        .button-hint {
            margin: 0 0 20px;
            color: #aaa;
        }
        
        .progress-container {
            width: 100%;
            background-color: #333;
            height: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .log-container {
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            margin-bottom: 20px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .log-info {
            color: #4a90e2;
        }
        
        .log-warning {
            color: #ffcc00;
        }
        
        .log-error {
            color: #ff4040;
        }
        
        .status-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .status-text {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .status-running {
            color: #4a90e2;
        }
        
        .status-completed {
            color: #00cc44;
        }
        
        .status-error {
            color: #ff4040;
        }

        .status-warning {
            color: #ffcc00;
        }
        
        .back-button {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px;
            text-decoration: none;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .back-button:hover {
            background-color: var(--accent-color);
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #333;
            color: #777;
        }
    </style>
</head>
<body>
    <header>
        <h1>Diablo 4 Build Search Tool</h1>
        <p>Refreshing build and equipment data</p>
    </header>
    
    <nav class="main-nav">
        <div class="container">
            <ul class="nav-list">
                <li><a href="/" class="nav-item {% if active_page == 'search' %}active{% endif %}">Search</a></li>
                <li><a href="/tier-list" class="nav-item {% if active_page == 'tier-list' %}active{% endif %}">Equipment Tier List</a></li>
                <li><a href="/unique-translations" class="nav-item {% if active_page == 'unique-reference' %}active{% endif %}">Unique Name Reference</a></li>
                <li><a href="/refresh-data" class="nav-item {% if active_page == 'refresh' %}active{% endif %}" id="refresh-data-link">Refresh Data</a></li>
            </ul>
        </div>
    </nav>
    
    <div class="container">
        <div class="refresh-container">
            <div class="refresh-header">
                <h2 class="refresh-title">Refreshing Data</h2>
            </div>

            <div class="button-group">
                <button class="refresh-button primary" data-refresh-mode="real">Start Full Refresh</button>
                <button class="refresh-button" data-refresh-mode="fake">Run Fake Refresh (20s)</button>
            </div>

            <p class="button-hint">Use the fake refresh to validate the progress updates without triggering the full scraper.</p>

            <div class="status-container">
                <div class="status-text" id="status-text">Status: Waiting to start</div>
                <div id="build-count">Builds: 0/?</div>
            </div>

            <div class="progress-container">
                <div class="progress-bar" id="progress-bar">0%</div>
            </div>

            <div class="log-container" id="log-container">
                <div class="log-entry log-info">Select a refresh option to begin.</div>
            </div>

            <div id="completion-message" style="display: none;">
                <p id="completion-text">Refresh completed successfully! You can now:</p>
                <div style="display: flex; gap: 15px; margin-top: 15px;">
                    <a href="/" class="back-button">Return to Search</a>
                    <a href="/tier-list" class="back-button">View Equipment Tier List</a>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Data sourced from <a href="https://maxroll.gg/d4/build-guides" target="_blank">MaxRoll.gg</a></p>
            <p>This tool is not affiliated with MaxRoll or Blizzard Entertainment.</p>
        </div>
    </div>
    
    <script>
        const logContainer = document.getElementById('log-container');
        const progressBar = document.getElementById('progress-bar');
        const statusText = document.getElementById('status-text');
        const buildCount = document.getElementById('build-count');
        const completionMessage = document.getElementById('completion-message');
        const completionText = document.getElementById('completion-text');
        const refreshButtons = document.querySelectorAll('[data-refresh-mode]');

        const REFRESH_CONFIG = {
            real: {
                startUrl: '/api/refresh-data',
                eventsUrl: '/api/refresh-events',
                label: 'Full data refresh',
                completion: 'Data refresh completed successfully! You can now:',
                confirm: 'Warning: Refreshing data will scrape all build pages from MaxRoll.gg and may take 10 minutes or longer to complete. During this time, the server will be busy and may be less responsive.\n\nDo you want to continue?'
            },
            fake: {
                startUrl: '/api/refresh-data-fake',
                eventsUrl: '/api/refresh-events',
                label: 'Fake refresh (20s test)',
                completion: 'Fake refresh completed. The UI update logic is working as expected.'
            }
        };

        let eventSource = null;
        let refreshActive = false;
        let lastKnownTotal = 0;
        let activeMode = null;

        function setButtonsDisabled(disabled) {
            refreshButtons.forEach(button => {
                button.disabled = disabled;
            });
        }

        function resetProgressDisplay(label) {
            statusText.textContent = label ? `Status: Initializing ${label}` : 'Status: Running...';
            statusText.className = 'status-text status-running';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            buildCount.textContent = 'Builds: 0/?';
            completionMessage.style.display = 'none';
            logContainer.innerHTML = '';
            lastKnownTotal = 0;
        }

        function finishRefresh() {
            refreshActive = false;
            activeMode = null;
            setButtonsDisabled(false);
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        }

        // Function to add a log entry
        function addLogEntry(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = message;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Function to update progress
        function updateProgress(current, total) {
            const parsedCurrent = Number(current);
            const parsedTotal = Number(total);
            const numericCurrent = Number.isFinite(parsedCurrent) ? parsedCurrent : 0;
            const numericTotal = Number.isFinite(parsedTotal) ? parsedTotal : 0;

            if (numericTotal > 0) {
                lastKnownTotal = numericTotal;
            }

            const effectiveTotal = lastKnownTotal > 0 ? lastKnownTotal : 0;
            const percentage = effectiveTotal > 0 ? Math.min(100, Math.round((numericCurrent / effectiveTotal) * 100)) : 0;

            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = `${percentage}%`;
            const totalLabel = lastKnownTotal > 0 ? lastKnownTotal : '?';
            buildCount.textContent = `Builds: ${numericCurrent}/${totalLabel}`;
        }

        // Function to mark as completed
        function markCompleted(buildCountValue) {
            statusText.textContent = 'Status: Completed';
            statusText.className = 'status-text status-completed';
            progressBar.style.width = '100%';
            progressBar.textContent = '100%';
            completionMessage.style.display = 'block';
            const config = activeMode ? REFRESH_CONFIG[activeMode] : null;
            const completionLabel = config ? config.completion : 'Refresh completed successfully.';
            completionText.textContent = completionLabel;
            if (Number.isFinite(buildCountValue) && buildCountValue > 0) {
                lastKnownTotal = buildCountValue;
                buildCount.textContent = `Builds: ${buildCountValue}/${buildCountValue}`;
            }
            addLogEntry(`Refresh completed successfully. Found ${buildCountValue} builds.`, 'info');
            finishRefresh();
        }

        // Function to mark as error
        function markError(error) {
            statusText.textContent = 'Status: Error';
            statusText.className = 'status-text status-error';
            addLogEntry(`Error: ${error}`, 'error');
            finishRefresh();
        }

        function connectToEventStream(config) {
            if (eventSource) {
                eventSource.close();
            }

            eventSource = new EventSource(config.eventsUrl);

            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);

                    if (data.type === 'log') {
                        addLogEntry(data.message, data.log_level || 'info');
                    } else if (data.type === 'progress') {
                        updateProgress(data.current, data.total);
                    } else if (data.type === 'completed') {
                        markCompleted(data.build_count);
                    } else if (data.type === 'error') {
                        markError(data.message);
                    } else {
                        addLogEntry(`Unknown event type: ${data.type}`, 'warning');
                    }
                } catch (parseError) {
                    addLogEntry(`Error processing event: ${parseError.message}`, 'error');
                }
            };

            eventSource.onopen = function() {
                const modeLabel = config.label || 'Refresh';
                addLogEntry('Connected to event stream', 'info');
                statusText.textContent = `Status: Running (${modeLabel})`;
            };

            eventSource.onerror = function() {
                if (!refreshActive) {
                    if (eventSource) {
                        eventSource.close();
                        eventSource = null;
                    }
                    return;
                }
                addLogEntry('Connection to server lost. The refresh process may still be running in the background.', 'warning');
                statusText.textContent = 'Status: Connection lost';
                statusText.className = 'status-text status-warning';
                finishRefresh();
            };
        }

        function startRefresh(mode) {
            const config = REFRESH_CONFIG[mode];
            if (!config) {
                return;
            }

            if (refreshActive) {
                addLogEntry('A refresh is already in progress. Please wait for it to finish.', 'warning');
                return;
            }

            if (config.confirm && !confirm(config.confirm)) {
                return;
            }

            refreshActive = true;
            activeMode = mode;
            setButtonsDisabled(true);
            resetProgressDisplay(config.label);
            addLogEntry(`${config.label} starting...`, 'info');

            fetch(config.startUrl)
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(body => {
                            throw new Error(body.message || 'Failed to start refresh');
                        });
                    }
                    return response.json();
                })
                .then(() => {
                    addLogEntry('Refresh process started. Connecting to event stream...', 'info');
                    connectToEventStream(config);
                })
                .catch(error => {
                    markError(error.message);
                });
        }

        refreshButtons.forEach(button => {
            button.addEventListener('click', () => {
                const mode = button.getAttribute('data-refresh-mode');
                startRefresh(mode);
            });
        });
    </script>
</body>
</html>
